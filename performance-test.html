<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIPardy Performance Test Suite</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0f0c29;
            color: #00ff00;
            padding: 20px;
            line-height: 1.6;
        }
        .test-container {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00ff00;
            padding: 20px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .test-result {
            margin: 5px 0;
            padding: 5px;
        }
        .pass { color: #00ff00; }
        .fail { color: #ff0000; }
        .warning { color: #ffff00; }
        .info { color: #00ffff; }
        button {
            background: #1a1a2e;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 3px;
        }
        button:hover {
            background: #16213e;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .metric {
            background: rgba(0, 255, 0, 0.1);
            padding: 10px;
            border-radius: 3px;
            text-align: center;
        }
        .loading {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <h1>ðŸš€ BIPardy Performance & Security Test Suite</h1>
    
    <div class="test-container">
        <h2>ðŸ“Š Performance Metrics</h2>
        <button onclick="runPerformanceTests()">Run Performance Tests</button>
        <div id="performanceResults"></div>
    </div>
    
    <div class="test-container">
        <h2>ðŸ”’ Security Validation Tests</h2>
        <button onclick="runSecurityTests()">Run Security Tests</button>
        <div id="securityResults"></div>
    </div>
    
    <div class="test-container">
        <h2>âš¡ Module Loading Tests</h2>
        <button onclick="runModuleTests()">Test Module Loading</button>
        <div id="moduleResults"></div>
    </div>
    
    <div class="test-container">
        <h2>ðŸ§ª Memory Usage Analysis</h2>
        <button onclick="runMemoryTests()">Analyze Memory</button>
        <div id="memoryResults"></div>
    </div>
    
    <div class="test-container">
        <h2>ðŸ“ˆ DOM Performance Tests</h2>
        <button onclick="runDOMTests()">Test DOM Operations</button>
        <div id="domResults"></div>
    </div>

    <script type="module">
        // Performance testing utilities
        class PerformanceTestSuite {
            constructor() {
                this.results = [];
                this.startTime = 0;
                this.modules = {};
            }
            
            log(message, type = 'info') {
                const result = {
                    message,
                    type,
                    timestamp: Date.now()
                };
                this.results.push(result);
                return result;
            }
            
            displayResults(containerId) {
                const container = document.getElementById(containerId);
                container.innerHTML = this.results.map(result => {
                    return `<div class="test-result ${result.type}">[${result.type.toUpperCase()}] ${result.message}</div>`;
                }).join('');
            }
            
            async measureAsync(name, fn) {
                const start = performance.now();
                try {
                    const result = await fn();
                    const duration = performance.now() - start;
                    this.log(`${name}: ${duration.toFixed(2)}ms`, 'pass');
                    return { result, duration };
                } catch (error) {
                    const duration = performance.now() - start;
                    this.log(`${name}: FAILED after ${duration.toFixed(2)}ms - ${error.message}`, 'fail');
                    throw error;
                }
            }
            
            measure(name, fn) {
                const start = performance.now();
                try {
                    const result = fn();
                    const duration = performance.now() - start;
                    this.log(`${name}: ${duration.toFixed(2)}ms`, 'pass');
                    return { result, duration };
                } catch (error) {
                    const duration = performance.now() - start;
                    this.log(`${name}: FAILED after ${duration.toFixed(2)}ms - ${error.message}`, 'fail');
                    throw error;
                }
            }
        }
        
        const testSuite = new PerformanceTestSuite();
        
        // Performance tests
        window.runPerformanceTests = async function() {
            testSuite.results = [];
            const container = document.getElementById('performanceResults');
            container.innerHTML = '<div class="loading">Running performance tests...</div>';
            
            try {
                // Test module loading speed
                await testSuite.measureAsync('Timer Module Load', async () => {
                    const { timerManager } = await import('./js/modules/timer.js');
                    return timerManager;
                });
                
                await testSuite.measureAsync('UI Controller Load', async () => {
                    const { uiController } = await import('./js/modules/ui-controller.js');
                    return uiController;
                });
                
                await testSuite.measureAsync('Leaderboard Module Load', async () => {
                    const { VirtualLeaderboard } = await import('./js/modules/leaderboard.js');
                    return new VirtualLeaderboard();
                });
                
                // Test DOM operations
                testSuite.measure('1000 DOM Queries', () => {
                    for (let i = 0; i < 1000; i++) {
                        document.getElementById('performanceResults');
                    }
                });
                
                // Test array operations
                testSuite.measure('10000 Array Operations', () => {
                    const arr = Array.from({length: 10000}, (_, i) => i);
                    return arr.filter(x => x % 2 === 0).map(x => x * 2).reduce((a, b) => a + b, 0);
                });
                
                // Memory usage
                if (performance.memory) {
                    const memory = performance.memory;
                    testSuite.log(`Used JS Heap: ${(memory.usedJSHeapSize / 1024 / 1024).toFixed(2)} MB`, 'info');
                    testSuite.log(`Total JS Heap: ${(memory.totalJSHeapSize / 1024 / 1024).toFixed(2)} MB`, 'info');
                    testSuite.log(`Heap Limit: ${(memory.jsHeapSizeLimit / 1024 / 1024).toFixed(2)} MB`, 'info');
                }
                
                testSuite.log('All performance tests completed successfully!', 'pass');
                
            } catch (error) {
                testSuite.log(`Performance test failed: ${error.message}`, 'fail');
            }
            
            testSuite.displayResults('performanceResults');
        };
        
        // Security tests
        window.runSecurityTests = function() {
            testSuite.results = [];
            const container = document.getElementById('securityResults');
            container.innerHTML = '<div class="loading">Running security tests...</div>';
            
            try {
                // Test XSS protection
                testSuite.measure('XSS Protection Test', () => {
                    const maliciousInput = '<script>alert("XSS")</script>';
                    const div = document.createElement('div');
                    div.textContent = maliciousInput; // Should be safe
                    if (div.innerHTML.includes('<script>')) {
                        throw new Error('XSS vulnerability detected');
                    }
                    return 'XSS protection working';
                });
                
                // Test input validation
                testSuite.measure('Input Validation Test', () => {
                    const testInputs = [
                        { input: 'ValidName123', expected: true },
                        { input: '<script>', expected: false },
                        { input: 'a'.repeat(20), expected: false },
                        { input: '', expected: false },
                        { input: 'Test User', expected: false } // spaces not allowed
                    ];
                    
                    const validateName = (name) => {
                        return typeof name === 'string' && 
                               /^[A-Z0-9]{3,12}$/i.test(name) &&
                               !/[<>&"']/.test(name);
                    };
                    
                    testInputs.forEach(test => {
                        const result = validateName(test.input);
                        if (result !== test.expected) {
                            throw new Error(`Validation failed for input: ${test.input}`);
                        }
                    });
                    
                    return 'Input validation working correctly';
                });
                
                // Test CSP headers
                testSuite.measure('CSP Header Check', () => {
                    const meta = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
                    if (!meta) {
                        throw new Error('CSP header not found');
                    }
                    const csp = meta.content;
                    if (!csp.includes("default-src 'self'")) {
                        throw new Error('CSP not restrictive enough');
                    }
                    return 'CSP header present and secure';
                });
                
                // Test local storage security
                testSuite.measure('LocalStorage Security Test', () => {
                    const sensitiveData = { password: 'secret123', apiKey: 'xyz789' };
                    
                    // Should never store sensitive data in plain text
                    localStorage.setItem('testData', JSON.stringify({ username: 'testUser' }));
                    
                    const stored = JSON.parse(localStorage.getItem('testData'));
                    if (stored.password || stored.apiKey) {
                        throw new Error('Sensitive data found in localStorage');
                    }
                    
                    localStorage.removeItem('testData');
                    return 'LocalStorage security check passed';
                });
                
                testSuite.log('All security tests passed!', 'pass');
                
            } catch (error) {
                testSuite.log(`Security test failed: ${error.message}`, 'fail');
            }
            
            testSuite.displayResults('securityResults');
        };
        
        // Module loading tests
        window.runModuleTests = async function() {
            testSuite.results = [];
            const container = document.getElementById('moduleResults');
            container.innerHTML = '<div class="loading">Testing module loading...</div>';
            
            try {
                const modules = [
                    { name: 'Timer', path: './js/modules/timer.js', export: 'timerManager' },
                    { name: 'UI Controller', path: './js/modules/ui-controller.js', export: 'uiController' },
                    { name: 'Leaderboard', path: './js/modules/leaderboard.js', export: 'VirtualLeaderboard' },
                    { name: 'Lazy Loader', path: './js/modules/lazy-loader.js', export: 'lazyLoader' },
                    { name: 'Social Sharing', path: './js/modules/social-sharing.js', export: 'SocialSharing' }
                ];
                
                for (const module of modules) {
                    await testSuite.measureAsync(`${module.name} Module Load`, async () => {
                        const imported = await import(module.path);
                        const exportedItem = imported[module.export];
                        if (!exportedItem) {
                            throw new Error(`Export ${module.export} not found`);
                        }
                        return exportedItem;
                    });
                }
                
                // Test web workers
                await testSuite.measureAsync('Score Worker Load', async () => {
                    return new Promise((resolve, reject) => {
                        try {
                            const worker = new Worker('./js/workers/score-worker.js');
                            worker.postMessage({ type: 'calculateScore', data: { 
                                id: 1, 
                                isCorrect: true, 
                                streak: 3, 
                                timerBonus: 15, 
                                wordLength: 6, 
                                helpUsed: false 
                            }});
                            
                            worker.onmessage = (e) => {
                                worker.terminate();
                                resolve(e.data);
                            };
                            
                            worker.onerror = (error) => {
                                worker.terminate();
                                reject(error);
                            };
                            
                            setTimeout(() => {
                                worker.terminate();
                                reject(new Error('Worker timeout'));
                            }, 2000);
                        } catch (error) {
                            reject(error);
                        }
                    });
                });
                
                testSuite.log('All module loading tests passed!', 'pass');
                
            } catch (error) {
                testSuite.log(`Module test failed: ${error.message}`, 'fail');
            }
            
            testSuite.displayResults('moduleResults');
        };
        
        // Memory tests
        window.runMemoryTests = function() {
            testSuite.results = [];
            const container = document.getElementById('memoryResults');
            container.innerHTML = '<div class="loading">Analyzing memory usage...</div>';
            
            try {
                if (!performance.memory) {
                    testSuite.log('Performance.memory API not available', 'warning');
                    testSuite.displayResults('memoryResults');
                    return;
                }
                
                const before = performance.memory.usedJSHeapSize;
                
                // Create memory pressure
                testSuite.measure('Memory Allocation Test', () => {
                    const arrays = [];
                    for (let i = 0; i < 1000; i++) {
                        arrays.push(new Array(1000).fill(Math.random()));
                    }
                    
                    // Clean up
                    arrays.length = 0;
                    return 'Memory test completed';
                });
                
                // Force garbage collection if available
                if (window.gc) {
                    window.gc();
                }
                
                const after = performance.memory.usedJSHeapSize;
                const used = (after / 1024 / 1024).toFixed(2);
                const total = (performance.memory.totalJSHeapSize / 1024 / 1024).toFixed(2);
                const limit = (performance.memory.jsHeapSizeLimit / 1024 / 1024).toFixed(2);
                
                testSuite.log(`Current memory usage: ${used} MB`, 'info');
                testSuite.log(`Total heap size: ${total} MB`, 'info');
                testSuite.log(`Memory limit: ${limit} MB`, 'info');
                testSuite.log(`Memory usage: ${(used/limit*100).toFixed(1)}%`, used/limit > 0.8 ? 'warning' : 'pass');
                
            } catch (error) {
                testSuite.log(`Memory test failed: ${error.message}`, 'fail');
            }
            
            testSuite.displayResults('memoryResults');
        };
        
        // DOM performance tests
        window.runDOMTests = function() {
            testSuite.results = [];
            const container = document.getElementById('domResults');
            container.innerHTML = '<div class="loading">Testing DOM performance...</div>';
            
            try {
                // Test DOM element creation
                testSuite.measure('Create 1000 DOM Elements', () => {
                    const fragment = document.createDocumentFragment();
                    for (let i = 0; i < 1000; i++) {
                        const div = document.createElement('div');
                        div.textContent = `Element ${i}`;
                        div.className = 'test-element';
                        fragment.appendChild(div);
                    }
                    return fragment.children.length;
                });
                
                // Test style changes
                testSuite.measure('1000 Style Changes', () => {
                    const testEl = document.createElement('div');
                    document.body.appendChild(testEl);
                    
                    for (let i = 0; i < 1000; i++) {
                        testEl.style.left = i + 'px';
                    }
                    
                    document.body.removeChild(testEl);
                    return 'Style changes completed';
                });
                
                // Test querySelector performance
                testSuite.measure('1000 Query Selectors', () => {
                    for (let i = 0; i < 1000; i++) {
                        document.querySelector('body');
                    }
                    return 'Query selectors completed';
                });
                
                // Test event handling
                testSuite.measure('Event Handler Performance', () => {
                    const button = document.createElement('button');
                    document.body.appendChild(button);
                    
                    let eventCount = 0;
                    const handler = () => eventCount++;
                    
                    button.addEventListener('click', handler);
                    
                    // Simulate 100 clicks
                    for (let i = 0; i < 100; i++) {
                        button.click();
                    }
                    
                    button.removeEventListener('click', handler);
                    document.body.removeChild(button);
                    
                    return `${eventCount} events processed`;
                });
                
                testSuite.log('All DOM performance tests completed!', 'pass');
                
            } catch (error) {
                testSuite.log(`DOM test failed: ${error.message}`, 'fail');
            }
            
            testSuite.displayResults('domResults');
        };
        
    </script>
</body>
</html>